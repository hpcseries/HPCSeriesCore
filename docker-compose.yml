services:
  # CPU-only development container (default)
  hpcs-dev:
    build:
      context: .
      dockerfile: Dockerfile
    image: hpcseries-core:dev
    container_name: hpcseries-dev

    # Mount current directory to /workspace in container
    volumes:
      - .:/workspace

    # Keep container running
    stdin_open: true
    tty: true

    # Set working directory
    working_dir: /workspace

    # Default command
    command: /bin/bash

  # GPU-enabled container for GPU testing and benchmarking
  hpcs-gpu:
    build:
      context: .
      dockerfile: Dockerfile.gpu
    image: hpcseries-core:gpu
    container_name: hpcseries-gpu

    # Mount current directory to /workspace in container
    volumes:
      - .:/workspace

    # GPU configuration for NVIDIA Container Toolkit
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility]

    # Keep container running
    stdin_open: true
    tty: true

    # Set working directory
    working_dir: /workspace

    # Environment variables for GPU
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - OMP_TARGET_OFFLOAD=MANDATORY
      - OMP_DEFAULT_DEVICE=0

    # Default command
    command: /bin/bash
