name: Build Wheels

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-test*'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build-wheels:
    name: Build manylinux wheels
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Build manylinux wheels
      uses: pypa/cibuildwheel@v2.21.3
      env:
        # Build for Python 3.8 through 3.12
        CIBW_BUILD: "cp38-* cp39-* cp310-* cp311-* cp312-*"

        # Only x86_64 for now (ARM/aarch64 can be added later)
        CIBW_ARCHS_LINUX: "x86_64"

        # Skip musllinux (focus on manylinux glibc-based)
        CIBW_SKIP: "*musllinux*"

        # Install build dependencies in manylinux container
        # manylinux2014 uses yum, manylinux_2_28+ uses dnf
        CIBW_BEFORE_ALL_LINUX: >
          yum install -y gcc-gfortran cmake3 ||
          dnf install -y gcc-gfortran cmake

        # Build native library before building Python extension
        CIBW_BEFORE_BUILD: >
          pip install numpy Cython &&
          cmake --version &&
          gfortran --version

        # Test that the wheel works
        CIBW_TEST_REQUIRES: numpy
        CIBW_TEST_COMMAND: >
          python -c "import hpcs; print('Version:', hpcs.__version__);
          import numpy as np;
          x = np.random.randn(1000);
          print('Mean:', hpcs.mean(x));
          print('SIMD:', hpcs.simd_info())"

        # Build in parallel
        CIBW_BUILD_VERBOSITY: 1

    - name: Upload wheel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wheels-manylinux-${{ github.sha }}
        path: wheelhouse/*.whl
        retention-days: 7

  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build gcc gfortran

    - name: Build native library
      run: |
        mkdir -p build
        cd build
        cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=OFF -DBUILD_BENCHMARKS=OFF
        cmake --build . --parallel $(nproc)
        ls -lh libhpcs_core.a
        cd ..

    - name: Install Python build tools
      run: pip install --upgrade pip build twine

    - name: Build source distribution
      run: python -m build --sdist

    - name: Check distribution
      run: twine check dist/*

    - name: Upload sdist artifact
      uses: actions/upload-artifact@v4
      with:
        name: sdist-${{ github.sha }}
        path: dist/*.tar.gz
        retention-days: 7

  publish-testpypi:
    name: Publish to TestPyPI
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    environment: pypi-test
    if: startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '-test')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist-artifacts

    - name: Prepare dist directory
      run: |
        mkdir -p dist
        find dist-artifacts -name '*.whl' -exec cp {} dist/ \;
        find dist-artifacts -name '*.tar.gz' -exec cp {} dist/ \;
        ls -lh dist/

    - name: Publish to TestPyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        verbose: true
        print-hash: true

  publish-pypi:
    name: Publish to PyPI
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    environment: pypi
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-test')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist-artifacts

    - name: Prepare dist directory
      run: |
        mkdir -p dist
        find dist-artifacts -name '*.whl' -exec cp {} dist/ \;
        find dist-artifacts -name '*.tar.gz' -exec cp {} dist/ \;
        ls -lh dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        verbose: true
        print-hash: true

---
# Configuration Notes:
#
# This workflow builds both manylinux wheels and source distribution.
#
# Manylinux wheels:
# - Built using cibuildwheel in official manylinux containers
# - Include pre-compiled native library
# - Fast installation (no compilation needed)
# - Tagged as manylinux_2_28_x86_64 or manylinux2014_x86_64
#
# Source distribution (sdist):
# - Contains full source code
# - Builds native library automatically during pip install
# - Requires cmake, gcc, gfortran on user's system
# - Architecture-specific optimizations at install time
#
# Publishing:
# - TestPyPI: Tags matching v*.*.*-test* (e.g., v0.7.0-test1)
# - Production PyPI: Tags matching v*.*.* (e.g., v0.7.0)
#
# To enable Trusted Publishing:
# - PyPI: https://pypi.org/manage/account/publishing/
#   Environment: pypi, Workflow: build-wheels.yml
# - TestPyPI: https://test.pypi.org/manage/account/publishing/
#   Environment: pypi-test, Workflow: build-wheels.yml
